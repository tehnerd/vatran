# Katran Server Configuration Example
#
# This configuration file is read on server startup to:
# 1. Configure the HTTP/HTTPS server settings
# 2. Initialize the KatranLb load balancer
# 3. Populate VIPs and backends from the defined target groups
#
# Usage: katran-server -config /path/to/config.yaml

#------------------------------------------------------------------------------
# Server Configuration
#------------------------------------------------------------------------------
server:
  host: ""                    # Host to bind to (empty = all interfaces)
  port: 8080                  # Port to listen on

  # TLS configuration (optional - omit for plain HTTP)
  # tls:
  #   cert_file: "/path/to/cert.pem"
  #   key_file: "/path/to/key.pem"
  #   min_version: "1.2"        # Minimum TLS version (1.2 or 1.3)
  #   client_auth: "none"       # Client auth: none, request, require, verify
  #   client_ca_file: ""        # Path to client CA for mTLS

  # Timeouts (in seconds)
  read_timeout: 30
  write_timeout: 30
  idle_timeout: 120

  # Middleware
  enable_cors: false
  allowed_origins: []
  enable_logging: true
  enable_recovery: true

  # Static files for web UI (optional)
  # static_dir: "/path/to/static"

  # Base directory for BPF programs
  bpf_prog_dir: "/path/to/bpf"

  # Authentication configuration (optional)
  # auth:
  #   enabled: false                          # Enable authentication
  #   database_path: "/var/lib/katran/auth.db"  # SQLite database path
  #   allow_localhost: true                   # Bypass auth for localhost
  #   session_timeout: 24                     # Session timeout in hours
  #   bcrypt_cost: 12                         # bcrypt cost factor
  #   exempt_paths:                           # Paths exempt from auth
  #     - "/health"
  #     - "/static/*"
  #   bootstrap_admin:                        # Initial admin user (created if no users exist)
  #     username: "admin"
  #     password: "changeme"                  # CHANGE THIS IN PRODUCTION

#------------------------------------------------------------------------------
# Load Balancer Configuration
#------------------------------------------------------------------------------
lb:
  # Network interfaces
  interfaces:
    main: "eth0"              # Main interface for XDP attachment (required)
    healthcheck: "eth0"       # Interface for healthcheck BPF (defaults to main)
    v4_tunnel: ""             # IPv4 tunnel interface for HC encapsulation
    v6_tunnel: ""             # IPv6 tunnel interface for HC encapsulation

  # BPF program paths (relative to bpf_prog_dir or absolute)
  programs:
    balancer: "balancer.bpf.o"
    healthcheck: "healthchecking.bpf.o"

  # Root map configuration (for shared XDP mode)
  root_map:
    enabled: false            # Use root map (true) or standalone mode (false)
    path: ""                  # Path to pinned BPF map from root XDP program
    position: 2               # Position in root map for Katran's program FD

  # MAC addresses (hex format aa:bb:cc:dd:ee:ff)
  mac:
    default: ""               # Gateway/router MAC address
    local: ""                 # Local server MAC address

  # Capacity limits
  capacity:
    max_vips: 512             # Maximum number of VIPs
    max_reals: 4096           # Maximum number of real servers
    ch_ring_size: 65537       # Consistent hashing ring size per VIP
    lru_size: 8000000         # Per-CPU LRU connection tracking table size
    global_lru_size: 100000   # Per-CPU global LRU map size
    max_lpm_src: 3000000      # Maximum source routing LPM entries
    max_decap_dst: 6          # Maximum inline decapsulation destinations

  # CPU and NUMA configuration (optional - leave empty for auto-detection)
  cpu:
    forwarding_cores: []      # List of CPU cores for packet forwarding
    numa_nodes: []            # NUMA node mapping for forwarding cores

  # XDP configuration
  xdp:
    attach_flags: 0           # XDP attachment flags
    priority: 2307            # TC priority for healthcheck program

  # GUE encapsulation source addresses
  encapsulation:
    src_v4: ""                # IPv4 source for GUE-encapsulated packets
    src_v6: ""                # IPv6 source for GUE-encapsulated packets

  # Feature flags
  features:
    enable_healthcheck: true
    tunnel_based_hc_encap: true
    flow_debug: false
    enable_cid_v3: false
    memlock_unlimited: true
    cleanup_on_shutdown: true
    testing: false            # Testing mode - don't program forwarding plane

  # Hash function: "maglev" or "maglev_v2"
  hash_function: "maglev"

#------------------------------------------------------------------------------
# Target Groups (Reusable Backend Pools)
#------------------------------------------------------------------------------
# Define named groups of backend servers that can be referenced by VIPs.
# This allows multiple VIPs (e.g., port 80 and 443) to share the same backends.

target_groups:
  # Example: Web servers
  web-servers:
    - address: "10.0.0.1"
      weight: 100
      flags: 0
    - address: "10.0.0.2"
      weight: 100
    - address: "10.0.0.3"
      weight: 50              # Lower weight = less traffic

  # Example: API servers
  api-servers:
    - address: "10.0.1.1"
      weight: 100
    - address: "10.0.1.2"
      weight: 100

  # Example: IPv6 backends
  web-servers-v6:
    - address: "fc00::1"
      weight: 100
    - address: "fc00::2"
      weight: 100

#------------------------------------------------------------------------------
# VIP Configuration
#------------------------------------------------------------------------------
# Define Virtual IPs and associate them with target groups.
# Multiple VIPs can reference the same target group.

vips:
  # HTTP traffic
  - address: "192.168.1.100"
    port: 80
    proto: "tcp"              # tcp, udp
    target_group: web-servers
    flags: 0                  # Optional VIP flags

  # HTTPS traffic (same backends as HTTP)
  - address: "192.168.1.100"
    port: 443
    proto: "tcp"
    target_group: web-servers

  # API endpoint
  - address: "192.168.1.101"
    port: 8443
    proto: "tcp"
    target_group: api-servers

  # UDP example (DNS)
  - address: "192.168.1.102"
    port: 53
    proto: "udp"
    target_group: api-servers

  # IPv6 VIP
  - address: "2001:db8::1"
    port: 443
    proto: "tcp"
    target_group: web-servers-v6
